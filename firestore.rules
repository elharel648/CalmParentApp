rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===================
    // HELPER FUNCTIONS
    // ===================
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ===================
    // USERS COLLECTION
    // ===================
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }

    // ===================
    // ===================
    // FAMILIES COLLECTION
    // ===================
    match /families/{familyId} {
      // Read: any authenticated user (needed to query by inviteCode for joining)
      allow read: if isAuthenticated();
      
      // Create: any authenticated
      allow create: if isAuthenticated();
      
      // Update: any authenticated user
      // Security note: Client code validates invite codes before allowing join
      allow update: if isAuthenticated();
      
      // Delete: only creator
      allow delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
      
      // Presence subcollection
      match /presence/{memberId} {
        allow read, write: if isAuthenticated();
      }
    }

    // ===================
    // BABIES COLLECTION
    // ===================
    match /babies/{babyId} {
      // Read: parent OR any authenticated user who might be in family
      // (Simplified to avoid blocking access)
      allow read: if isAuthenticated();
      
      // Create: authenticated with parentId matching
      allow create: if isAuthenticated() && request.resource.data.parentId == request.auth.uid;
      
      // Update: parent
      allow update: if isAuthenticated() && (
        resource.data.parentId == request.auth.uid
      );
      
      // Delete: only parent
      allow delete: if isAuthenticated() && resource.data.parentId == request.auth.uid;
    }

    // ===================
    // EVENTS COLLECTION
    // ===================
    match /events/{eventId} {
      // Read: any authenticated (filtering done client-side by childId)
      allow read: if isAuthenticated();
      
      // Create: any authenticated
      allow create: if isAuthenticated();
      
      // Update/Delete: creator
      allow update, delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        resource.data.creatorId == request.auth.uid
      );
    }

    // ===================
    // INVITES COLLECTION
    // ===================
    match /invites/{inviteCode} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Allow creator to update, OR allow anyone to mark as used
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['used', 'usedBy', 'usedAt'])
      );
      allow delete: if false;
    }

    // ===================
    // PRESENCE COLLECTION
    // ===================
    match /presence/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && request.auth.uid == docId;
    }

    // ===================
    // SITTERS COLLECTION
    // ===================
    match /sitters/{sitterId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == sitterId;
      allow update, delete: if isAuthenticated() && request.auth.uid == sitterId;
    }

    // ===================
    // BOOKINGS COLLECTION
    // ===================
    match /bookings/{bookingId} {
      allow read: if isAuthenticated() && (
        resource.data.parentId == request.auth.uid ||
        resource.data.sitterId == request.auth.uid
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        resource.data.parentId == request.auth.uid ||
        resource.data.sitterId == request.auth.uid
      );
      allow delete: if isAuthenticated() && resource.data.parentId == request.auth.uid;
    }

    // ===================
    // NOTIFICATIONS COLLECTION
    // ===================
    match /notifications/{notificationId} {
      // Relaxed read to fix "Missing Permissions" error during query validation
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ===================
    // GROWTH MEASUREMENTS COLLECTION
    // ===================
    match /growthMeasurements/{measurementId} {
      // Read: any authenticated user (filtering by babyId done client-side)
      allow read: if isAuthenticated();
      
      // Create: any authenticated user
      allow create: if isAuthenticated();
      
      // Update/Delete: creator only
      allow update, delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
    }

    // ===================
    // TEETH TRACKER COLLECTION
    // ===================
    match /teeth/{toothId} {
      // Read: any authenticated user
      allow read: if isAuthenticated();
      
      // Create: any authenticated user
      allow create: if isAuthenticated();
      
      // Update/Delete: creator only
      allow update, delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
    }
  }
}
